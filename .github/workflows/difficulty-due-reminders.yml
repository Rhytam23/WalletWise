name: Daily due-date reminders (by difficulty)

on:
  schedule:
    # Daily at 09:30 IST (04:00 UTC). GitHub cron uses UTC.
    - cron: "0 4 * * *"
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  remind:
    runs-on: ubuntu-latest
    steps:
      - name: Comment daily reminders with computed due date
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const SLA = {
              "difficulty: easy": 2,
              "difficulty: medium": 4,
              "difficulty: hard": 7,
            };

            // marker to avoid multiple reminders on the same day
            const now = new Date();
            const dayStamp = now.toISOString().slice(0, 10); // YYYY-MM-DD (UTC)
            const dailyMarker = `<!-- daily-difficulty-reminder:${dayStamp} -->`;

            const msPerDay = 24 * 60 * 60 * 1000;

            function addDaysUTC(dateObj, days) {
              const d = new Date(dateObj);
              d.setUTCDate(d.getUTCDate() + days);
              return d;
            }

            function isoDate(d) {
              return d.toISOString().slice(0, 10);
            }

            // fetch open issues
            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner,
              repo,
              state: "open",
              per_page: 100,
            });

            for (const issue of issues) {
              if (issue.pull_request) continue; // skip PRs

              const labels = (issue.labels || []).map(l => (typeof l === "string" ? l : l.name));
              const diffLabel = Object.keys(SLA).find(l => labels.includes(l));
              if (!diffLabel) continue;

              const assignees = (issue.assignees || []).map(a => a.login);
              if (assignees.length === 0) continue; // you wanted due date from assigned date

              const slaDays = SLA[diffLabel];

              // get assignment date from issue events timeline
              const events = await github.paginate(github.rest.issues.listEvents, {
                owner,
                repo,
                issue_number: issue.number,
                per_page: 100,
              });

              const assignedEvents = events
                .filter(e => e.event === "assigned" && e.created_at)
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

              const assignedAt = assignedEvents.length
                ? new Date(assignedEvents[0].created_at)
                : new Date(issue.created_at); // fallback

              const dueAt = addDaysUTC(assignedAt, slaDays);

              const daysLeft = Math.ceil((dueAt - now) / msPerDay);
              const assignedDateStr = isoDate(assignedAt);
              const dueDateStr = isoDate(dueAt);

              // prevent multiple reminders on same day
              const comments = await github.paginate(github.rest.issues.listComments, {
                owner,
                repo,
                issue_number: issue.number,
                per_page: 100,
              });

              if (comments.some(c => (c.body || "").includes(dailyMarker))) continue;

              const mentions = assignees.map(u => `@${u}`).join(" ");

              let statusLine;
              let actionLine;

              if (daysLeft > 0) {
                statusLine = `âœ… **${daysLeft} day(s) left** (due on **${dueDateStr}**)`;
                actionLine = `Please share a quick update (progress + blockers).`;
              } else if (daysLeft === 0) {
                statusLine = `âš ï¸ **Due today** (**${dueDateStr}**)`;
                actionLine = `Please finish today or comment blockers.`;
              } else {
                statusLine = `ðŸš¨ **Overdue by ${Math.abs(daysLeft)} day(s)** (was due on **${dueDateStr}**)`;
                actionLine = `Please complete **ASAP**. If thereâ€™s no progress update soon, this may be **reassigned** to someone else.`;
              }

              const body =
`${dailyMarker}
â° **Daily Reminder** (${diffLabel})

- Assigned on: **${assignedDateStr}**
- SLA: **${slaDays} days**
- ${statusLine}

${mentions}
${actionLine}
`;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issue.number,
                body,
              });

              console.log(`Reminded #${issue.number} (${diffLabel}) -> ${mentions}`);


